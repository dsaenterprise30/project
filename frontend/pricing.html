<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Pricing</title>

  <!-- Razorpay Checkout -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>

  <!-- ================= CSS ================= -->
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f6f6f6;
      margin: 0;
      padding: 0;
      text-align: center;
    }

    :root {
      --primary-blue: #1e3a8a;
      --secondary-blue: #3b82f6;
      --bg-white: #fff;
    }

    h1 {
      margin-top: 40px;
    }

    .btn {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary-blue);
      color: white;
      font-size: 1rem;
      font-weight: bold;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      margin-top: 1rem;
      transition: background 0.3s;
    }

    .btn:hover {
      background: var(--secondary-blue);
    }

    .plans-container {
      display: flex;
      justify-content: center;
      gap: 20px;
      margin: 40px;
      flex-wrap: wrap;
      padding: 0 16px;
      align-items: stretch;
    }

    .plan-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 25px;
      width: 260px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      position: relative;
    }

    .badge {
      position: absolute;
      top: -10px;
      right: -10px;
      background: #ff9800;
      color: #fff;
      padding: 6px 10px;
      font-size: 12px;
      border-radius: 20px;
    }

    .plan-price {
      font-size: 26px;
      margin: 15px 0;
    }

    .price-block {
      display: flex;
      align-items: baseline;
      gap: 8px;
      justify-content: center;
      flex-wrap: wrap;
    }

    .original-price {
      text-decoration: line-through;
      color: #888;
      font-size: 0.95rem;
    }

    .discounted-price {
      color: #111;
      font-weight: 700;
      font-size: 1.15rem;
    }

    .price-interval {
      color: #666;
      font-size: 0.95rem;
      margin-left: 4px;
    }

    .promo-text {
      color: #047857; /* green */
      font-size: 0.9rem;
      margin-top: 6px;
    }

    /* Card adjustments for responsiveness */
    .plan-card {
      background: #fff;
      border: 1px solid #ddd;
      border-radius: 10px;
      padding: 25px;
      width: 100%;
      max-width: 320px;
      flex: 1 1 260px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      position: relative;
      box-sizing: border-box;
    }

        /* Use global .btn styles for consistency */
        .plan-card .btn {
            margin-top: 1rem;
            transition: transform 0.2s ease;
            min-height: 44px;
        }

        .plan-card .btn:hover {
            transform: translateY(-2px);
        }

        .plan-card .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

    /* Responsive rules */
    @media (max-width: 768px) {
      .plans-container { gap: 16px; margin: 24px; padding: 0 12px; }
      .plan-card { padding: 20px; max-width: 380px; }
      h1 { font-size: 1.6rem; margin-top: 24px; }
    }

    @media (max-width: 480px) {
      .plans-container { flex-direction: column; gap: 12px; margin: 16px; padding: 0 12px; }
      .plan-card { padding: 16px; border-radius: 8px; max-width: 100%; }
      .plan-price { font-size: 20px; }
      .badge { top: -8px; right: -8px; padding: 4px 8px; font-size: 11px; }
      .btn { padding: 0.85rem; font-size: 1rem; }
    }
  </style>
</head>

<body>

  <h1>Choose Your Plan</h1>

  <div id="plans" class="plans-container">
    <!-- Plans will load here -->
  </div>

  <!-- ================= JS ================= -->
  <script type="module">
  import { RAZORPAY_KEY_ID } from './razorpayConfig.js';

  const plansContainer = document.getElementById("plans");

  // If redirected with ?mobile=, persist it to localStorage for the subscribe flow
  const params = new URLSearchParams(window.location.search);
  const incomingMobile = params.get('mobile');
  if (incomingMobile) localStorage.setItem('userMobileNumber', incomingMobile);

  async function loadPlans() {
    const res = await fetch("https://project-tbbc.onrender.com/api/plans");
    const plans = await res.json();

    plansContainer.innerHTML = "";

    const baselineMonthlyPlan = plans.find(p => p.duration === 1 && p.interval === "monthly");
    const baselineMonthlyPrice = baselineMonthlyPlan ? baselineMonthlyPlan.price : null;

    plans.forEach(plan => {
      const card = document.createElement("div");
      card.className = "plan-card";

      if (plan.planType === "YEARLY") {
        card.innerHTML += `<div class="badge">Most Popular Plan</div>`;
      }

      const monthsTotal = plan.interval === 'yearly' ? (plan.duration * 12) : plan.duration;
      const originalPrice = baselineMonthlyPrice ? baselineMonthlyPrice * monthsTotal : plan.price;
      const discountedPrice = plan.price;

      // Show interval label based on plan duration/interval
      const intervalLabel = (plan.interval === 'monthly')
        ? (plan.duration > 1 ? `per ${plan.duration} month${plan.duration>1 ? 's' : ''}` : ' / mo')
        : (plan.duration > 1 ? `per ${plan.duration} year${plan.duration>1 ? 's' : ''}` : ' / yr');

      const freeMonths = baselineMonthlyPrice ? Math.max(0, Math.round((originalPrice - discountedPrice) / baselineMonthlyPrice)) : 0;
      const buyMonths = Math.max(monthsTotal - freeMonths, 0);
      const promoText = plan.description ? plan.description : (freeMonths >= 1 ? `Buy ${buyMonths} month${buyMonths>1? 's' : ''} get ${freeMonths} month${freeMonths>1? 's' : ''} free.` : '');

      card.innerHTML += `
        <h2>${plan.name}</h2>
        <div class="plan-price">
          <div class="price-block">
            ${discountedPrice < originalPrice ? `<span class="original-price">₹${originalPrice.toLocaleString('en-IN')}</span>` : ''}
            <span class="discounted-price">₹${discountedPrice.toLocaleString('en-IN')}</span>
            <span class="price-interval"> ${intervalLabel}</span>
          </div>
        </div>
        ${promoText ? `<div class="promo-text">${promoText}</div>` : ''}
        <button class="btn">Subscribe</button>
      `;

      const btn = card.querySelector(".btn");
      btn.addEventListener("click", () => subscribe(plan.planType, btn));

      plansContainer.appendChild(card);
    });
  }

  async function subscribe(planType, btn) {
    btn.disabled = true;
    btn.innerText = "Processing...";

    // Support both keys depending on where we saved it
    const mobileNumber = localStorage.getItem("userMobileNumber") || localStorage.getItem("mobileNumber");
    if (!mobileNumber) {
      alert("Please login or register first");
      btn.disabled = false;
      btn.innerText = "Subscribe";
      return;
    }

    const res = await fetch("https://project-tbbc.onrender.com/api/payment/create-subscription", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ mobileNumber, planType }),
    });

    const data = await res.json();
    if (!res.ok) {
      alert(data.message || "Subscription failed");
      btn.disabled = false;
      btn.innerText = "Subscribe";
      return;
    }

    const rzp = new Razorpay({
      key: RAZORPAY_KEY_ID,
      subscription_id: data.subscriptionId,
      name: "Your App Name",
      handler: () => alert("Payment successful"),
    });

    rzp.open();
  }

  loadPlans();
</script>


</body>
</html>